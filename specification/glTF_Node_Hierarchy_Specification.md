# glTF/glb Node Hierarchy Specification

## Overview

This document describes the reverse-engineered specification of the glTF/glb structure generated by CxConverter, with a focus on node hierarchy construction from IFC elements.

---

## Overall Structure

```
glTF Model
├── scenes[0] (default scene)
│   └── nodes[rootNodeIndex] → "Z_UP" rotation node
│       └── children[0] → IfcProject node
│           ├── children[...] → IfcSite nodes
│           │   └── children[...] → IfcBuilding nodes
│           │       └── children[...] → IfcBuildingStorey nodes
│           │           └── children[...] → IfcElement nodes (walls, slabs, etc.)
│           │               └── children[...] → Item nodes (geometry instances)
│           └── children[...] → Direct child elements
```

---

## Node Hierarchy Levels

### Level 0: Root Transform Node

**Purpose:** Coordinate system conversion (IFC Z-up → glTF Y-up)

**Properties:**
- `name`: `"Z_UP"`
- `matrix`: 4x4 rotation matrix (-90° around X-axis by default)
- `children[0]`: IfcProject node index

---

### Level 1: IfcProject Node

**Location:** `ConverterGLTF.h:1250-1252`

**Purpose:** Root of IFC spatial hierarchy

**Properties:**
- `name`: IfcProject GUID or name
- `children[]`: IfcSite nodes, or direct child elements

---

### Level 2+: Spatial Container Nodes

**IFC Hierarchy (typical):**
```
IfcProject
  → IfcSite
    → IfcBuilding
      → IfcBuildingStorey
        → IfcElement (IfcWall, IfcSlab, etc.)
```

**Node Properties:**
- `name`: IFC element GUID or name
- `matrix` or `translation/rotation/scale`: Transformation from `IfcLocalPlacement`
- `children[]`: Child spatial elements or item nodes

---

### Level N: Element Nodes


**Purpose:** Represents IFC building elements (walls, slabs, beams, etc.)

**Properties:**
- `name`: IFC element name or GUID
- `matrix`: Local transformation
- `children[]`: Item nodes (geometry instances)

---

### Level N+1: Item Nodes

**Purpose:** Individual geometry instances with different representations or styles

**Properties:**
- `mesh`: Index to glTF mesh
- `matrix`: Transformation from `webifc::geometry::IfcPlacedGeometry`
- **No children** (leaf nodes)

**Creation:** One item node per `webifc::geometry::IfcPlacedGeometry` object

---

## Metadata Storage in Nodes


**Common extras fields:**
- `name`: IFC Name attribute (string)

---

## Special Cases

### Opening Elements


**Behavior:**
- `IFCOPENINGELEMENT` are not naturally in the spatial structure
- They are attached to their host element via `IFCRELVOIDSELEMENT`
- Parent-child relationship is established: opening → host element

---

### Grid Elements

**Behavior:**
- Grid axes exported as polylines (LINE_STRIP primitives)
- Text labels exported as POINTS primitives with extras
- Grid axes are children of IfcGrid element node


**Structure:**
```
IfcGrid node
  └── children[]
      ├── Grid axis polylines
      └── Text label points
```

---

### Text Labels

**Behavior:**
- Exported as POINTS primitives
- Position stored in vertex data (POSITION accessor)
- Text content in `primitive.extras.IfcAxisLabel`

**Structure:**
```json
{
  "primitives": [{
    "mode": 0,  // TINYGLTF_MODE_POINTS
    "attributes": {
      "POSITION": <accessor_index>
    },
    "extras": {
      "IfcAxisLabel": "A"  // Text content
    }
  }]
}
```

---

## Additional Notes

### Coordinate System Transformation

IFC uses Z-up coordinate system, while glTF uses Y-up. The root "Z_UP" node applies a -90° rotation around the X-axis to convert between these coordinate systems.

### Transformation Hierarchy

Transformations are accumulated down the hierarchy:
- Root "Z_UP" node: Coordinate system rotation
- Spatial nodes: Local placements from `IfcLocalPlacement`
- Item nodes: Placement transformations from `webifc::geometry::IfcPlacedGeometry`

