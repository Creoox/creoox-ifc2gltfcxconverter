# Metadata JSON Specification

## Overview

This document describes the specification of the `metadata.json` file generated by CxConverter alongside glb files. The metadata.json file contains IFC building model metadata extracted during the IFC to glTF conversion process.

---

## Purpose

The metadata.json file serves as a companion to the glTF/glb 3D geometry files, providing:

1. **Building element hierarchy** - Spatial structure and relationships between IFC elements
2. **Properties and property sets** - Attributes, quantities, and characteristics of building elements
3. **Units** - Unit definitions and conversions for all measurements
4. **Project information** - Metadata about the IFC project (author, schema version, creation date)

This separation allows:
- Lightweight 3D viewing (load only geometry)
- Rich metadata queries (without processing geometry)
- Efficient data management (split large datasets)

---

## Top-Level JSON Structure

```json
{
  "id": "string",
  "projectId": "string",
  "author": "string",
  "createdAt": "string",
  "schema": "string",
  "creatingApplication": "string",
  "properties": [...],
  "propertySets": [...],
  "units": [...],
  "projectUnits": {...},
  "metaObjects": [...]
  "groups": [...],
}
```

---

## 1. Basic Metadata Fields


These fields provide project-level information extracted from the IFC file header.

### Fields

| Field | Type | Required | Source | Description |
|-------|------|----------|--------|-------------|
| `id` | string | Yes | IFC FILE_NAME header | Project ID or file name |
| `projectId` | string | No | IfcProject GUID | IFC Project GloballyUniqueId |
| `author` | string | No | IFC FILE_NAME header, argument 2 | Author(s) from IFC header |
| `createdAt` | string | No | IFC FILE_NAME header, argument 1 | Creation timestamp (ISO 8601 format) |
| `schema` | string | No | IFC FILE_SCHEMA header | IFC schema version (e.g., "IFC2X3", "IFC4") |
| `creatingApplication` | string | No | IFC FILE_NAME header, argument 5 | Application that created the IFC file |

### Example

```json
{
  "id": "building_project_2024",
  "projectId": "2hk9fGH$H4Pxj3f8v_Dxg7",
  "author": "John Doe",
  "createdAt": "2024-02-19T12:14:41",
  "schema": "IFC4",
  "creatingApplication": "Autodesk Revit 2024"
}
```

### IFC FILE_NAME Structure

```
FILE_NAME(
  '...',                           // [0] id
  '2024-02-19T12:14:41',          // [1] createdAt
  ('John Doe'),                    // [2] author (from organizations in actual IFC)
  ('Company Name'),                // [3] organization
  'Preprocessor Version',          // [4] (not used)
  'Autodesk Revit 2024',          // [5] creatingApplication
  ''                               // [6] authorization
);
```

---

## 2. Properties Array


The `properties` array contains individual property and quantity definitions extracted from IFC property objects.

### Property Object Structure

```typescript
{
  "id"?: string,                   // Property GUID (optional)
  "name": string,                  // Property name
  "ifcPropertyType"?: string,      // IFC class (if exportIfcPropertyTypes enabled)
  "ifcValueType"?: string,         // IFC value type (if exportIfcValueTypes enabled)
  "value": any,                    // Property value
  "valueType": string,             // Value type category
  "unit"?: number,                 // Index into units array (optional)
  "properties"?: number[]          // Child property indices (for complex properties)
}
```

### Value Types

| valueType | Description | Example value | IFC Types |
|-----------|-------------|---------------|-----------|
| `"number"` | Numeric value | `3.5`, `100` | IfcInteger, IfcReal, IfcLengthMeasure, IfcAreaMeasure |
| `"string"` | Text value | `"Wall Type A"` | IfcLabel, IfcText, IfcIdentifier |
| `"boolean"` | Boolean value | `"True"`, `"False"` | IfcBoolean |
| `"logical"` | Logical value | `"True"`, `"False"`, `"Unknown"` | IfcLogical |
| `"array"` | Array of values | Multiple values | IfcPropertyListValue |
| `"enumeration"` | Enumerated value | Selected from list | IfcPropertyEnumeratedValue |
| `"ElementQuantity"` | Quantity value | Volume, area, length | IfcQuantityLength, IfcQuantityArea, IfcQuantityVolume |
| `"PropertySet"` | Property set container | Container | IfcPropertySet |
| `"ComplexProperty"` | Complex property | Nested properties | IfcComplexProperty |
| `"ComplexElementQuantity"` | Complex quantity | Nested quantities | IfcPhysicalComplexQuantity |

### Example Properties

```json
"properties": [
  {
    "name": "LoadBearing",
    "ifcPropertyType": "IfcPropertySingleValue",
    "ifcValueType": "IfcBoolean",
    "value": "True",
    "valueType": "boolean"
  },
  {
    "name": "Height",
    "ifcPropertyType": "IfcPropertySingleValue",
    "ifcValueType": "IfcLengthMeasure",
    "value": 3.5,
    "valueType": "number",
    "unit": 0
  },
  {
    "name": "FireRating",
    "ifcPropertyType": "IfcPropertySingleValue",
    "ifcValueType": "IfcLabel",
    "value": "2 Hour",
    "valueType": "string"
  },
  {
    "name": "GrossVolume",
    "ifcPropertyType": "IfcQuantityVolume",
    "value": 12.5,
    "valueType": "ElementQuantity",
    "unit": 3
  }
]
```

### IFC Property Sources  

- **IfcPropertySingleValue** - Single value property
- **IfcPropertyEnumeratedValue** - Value selected from enumeration
- **IfcPropertyListValue** - List of values
- **IfcPropertyBoundedValue** - Value with upper/lower bounds
- **IfcPropertyTableValue** - Table of values
- **IfcComplexProperty** - Property with nested properties
- **IfcQuantityLength** - Length quantity
- **IfcQuantityArea** - Area quantity
- **IfcQuantityVolume** - Volume quantity
- **IfcQuantityCount** - Count quantity
- **IfcQuantityWeight** - Weight quantity
- **IfcQuantityTime** - Time quantity

---

## 3. PropertySets Array

The `propertySets` array contains property set and element quantity definitions that group related properties.

### PropertySet Object Structure

```typescript
{
  "id": string,                    // PropertySet GUID
  "name": string,                  // PropertySet name
  "type": string,                  // IFC type
  "properties": number[]?           // Array of indices into properties array
}
```

### Example PropertySets

```json
"propertySets": [
  {
    "id": "3fG7k$Hj2_9Pxd8vD_xg7",
    "name": "Pset_WallCommon",
    "type": "IfcPropertySet",
    "properties": [0, 1, 2]
  },
  {
    "id": "1Wx8mNh3v5RxPd_7kD9xm",
    "name": "BaseQuantities",
    "type": "IfcElementQuantity",
    "properties": [3, 4, 5]
  }
]
```

### IFC PropertySet Sources

- **IfcPropertySet** - Named set of properties
- **IfcElementQuantity** - Named set of quantities
- **IfcDoorLiningProperties** - Door lining properties
- **IfcWindowLiningProperties** - Window lining properties

### Property References

PropertySets reference properties by **array index**:

```json
{
  "id": "pset-123",
  "properties": [0, 1, 2]  // References properties[0], properties[1], properties[2]
}
```

---

## 4. Units Array

**Location:** `MetaObjectsConverter.h:740-753`, `UnitContainer.h:172-256`

**Function:** `convertPropertySetsAndProperties()`, `writeUnitToJson()`

The `units` array contains unit definitions from the IFC model.

### Unit Object Structure

```typescript
{
  "name": string,                  // Unit symbol/name
  "className": string,             // IFC unit class
  "unitEnum"?: string,             // Unit type enum
  "unitType"?: string,             // Unit type (alternative)
  "prefix"?: string,               // SI prefix (for IfcSIUnit)
  "userDefinedType"?: string,      // User-defined type
  "conversionFactor"?: {           // Conversion factor (for IfcConversionBasedUnit)
    "valueComponent": {
      "value": number,
      "valueType": string,
      "ifcValueType": string
    },
    "unitComponent": number        // Reference to base unit index
  },
  "elements"?: [                   // For IfcDerivedUnit
    {
      "unit": number,              // Reference to unit index
      "exponent": number           // Exponent value
    }
  ],
  "dimensions"?: {                 // IfcDimensionalExponents
    "LengthExponent": number,
    "MassExponent": number,
    "TimeExponent": number,
    "ElectricCurrentExponent": number,
    "ThermodynamicTemperatureExponent": number,
    "AmountOfSubstanceExponent": number,
    "LuminousIntensityExponent": number
  }
}
```

### Unit Classes

| className | Description | Example |
|-----------|-------------|---------|
| `IfcSIUnit` | Standard SI units | meter, kilogram, second |
| `IfcConversionBasedUnit` | Units with conversion factors | degree, foot, inch |
| `IfcDerivedUnit` | Derived units (combinations) | W/m²K (thermal transmittance) |
| `IfcMonetaryUnit` | Currency units | USD, EUR |
| `IfcContextDependentUnit` | Context-dependent units | Custom units |

### Unit Type Enums

Common unit types include:
- `LENGTHUNIT` - Length measurements
- `AREAUNIT` - Area measurements
- `VOLUMEUNIT` - Volume measurements
- `PLANEANGLEUNIT` - Angles
- `MASSUNIT` - Mass/weight
- `TIMEUNIT` - Time
- `FORCEUNIT` - Force
- `POWERUNIT` - Power
- `THERMALTRANSMITTANCEUNIT` - Thermal transmittance

### SI Prefixes

| Prefix | Multiplier | Example |
|--------|------------|---------|
| `MILLI` | 10⁻³ | mm (millimeter) |
| `CENTI` | 10⁻² | cm (centimeter) |
| `KILO` | 10³ | kg (kilogram), kN (kilonewton) |
| `MEGA` | 10⁶ | MPa (megapascal) |

### Example Units

```json
"units": [
  {
    "name": "m",
    "className": "IfcSIUnit",
    "unitEnum": "LENGTHUNIT"
  },
  {
    "name": "mm",
    "className": "IfcSIUnit",
    "unitEnum": "LENGTHUNIT",
    "prefix": "MILLI"
  },
  {
    "name": "degree",
    "className": "IfcConversionBasedUnit",
    "unitEnum": "PLANEANGLEUNIT",
    "conversionFactor": {
      "valueComponent": {
        "value": 0.0174532925199433,
        "valueType": "number",
        "ifcValueType": "IfcReal"
      },
      "unitComponent": 5
    }
  },
  {
    "name": "W/m²K",
    "className": "IfcDerivedUnit",
    "unitEnum": "THERMALTRANSMITTANCEUNIT",
    "elements": [
      {
        "unit": 10,
        "exponent": 1
      },
      {
        "unit": 0,
        "exponent": -2
      },
      {
        "unit": 8,
        "exponent": -1
      }
    ]
  }
]
```

---

## 5. ProjectUnits Object


The `projectUnits` object maps unit types to their indices in the `units` array, defining the default units used throughout the project.

### Structure

```typescript
{
  "LENGTHUNIT": number,
  "AREAUNIT": number,
  "VOLUMEUNIT": number,
  "PLANEANGLEUNIT": number,
  "MASSUNIT": number,
  "TIMEUNIT": number,
  // ... other unit types
}
```

### Example

```json
"projectUnits": {
  "LENGTHUNIT": 0,
  "AREAUNIT": 2,
  "VOLUMEUNIT": 3,
  "PLANEANGLEUNIT": 4,
  "MASSUNIT": 6,
  "TIMEUNIT": 9
}
```

**Meaning:** All length measurements in the project use `units[0]` (typically meters), areas use `units[2]`, etc. 

---

## 6. MetaObjects Array

The `metaObjects` array contains metadata for IFC building elements, representing the spatial hierarchy and element properties.

### MetaObject Structure

```typescript
{
  "id": string,                    // Element GUID (IFC GloballyUniqueId)
  "name": string,                  // Element name
  "longName"?: string,             // Long name (for spatial elements)
  "type": string,                  // IFC entity type
  "parent": string | null,         // Parent element GUID (null for root)
  "groups"?: string[],             // Array of group GUIDs
  "ObjectType"?: string,           // ObjectType attribute (for IfcObject)
  "tag"?: string,                  // Tag attribute (for IfcElement)
  "attributes"?: {                 // Special attributes
    "elevation"?: number           // Elevation for IfcBuildingStorey
  },
  "propertySetIds"?: string[]      // Array of property set GUIDs
}
```

### Key Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | string | Yes | Unique IFC GloballyUniqueId (22 characters, Base64 encoded) |
| `name` | string | Yes | Element name from IFC Name attribute |
| `type` | string | Yes | IFC entity type (e.g., "IfcWall", "IfcDoor") |
| `parent` | string \| null | Yes | GUID of parent element (`null` for IfcProject) |
| `longName` | string | No | Long name for spatial elements (IfcSpatialElement) |
| `groups` | string[] | No | GUIDs of groups this element belongs to |
| `ObjectType` | string | No | ObjectType attribute from IfcObject |
| `tag` | string | No | Tag attribute from IfcElement |
| `propertySetIds` | string[] | No | GUIDs of property sets assigned to this element |

### Spatial Hierarchy

MetaObjects form a tree structure via the `parent` field:

```
IfcProject (parent: null)
  └── IfcSite (parent: <IfcProject GUID>)
      └── IfcBuilding (parent: <IfcSite GUID>)
          └── IfcBuildingStorey (parent: <IfcBuilding GUID>)
              └── IfcWall (parent: <IfcBuildingStorey GUID>)
                  └── IfcDoor (parent: <IfcWall GUID>)
```

### Property Set References

Property sets are linked via `propertySetIds`:

```json
{
  "id": "1Ri6dAvFvEOxun_An4x7m_",
  "type": "IfcWall",
  "propertySetIds": ["3fG7k$Hj2_9Pxd8vD_xg7", "1Wx8mNh3v5RxPd_7kD9xm"]
}
```

These GUIDs reference objects in the `propertySets` array by their `id` field.

### Example MetaObjects

```json
"metaObjects": [
  {
    "id": "2hk9fGH$H4Pxj3f8v_Dxg7",
    "name": "My Building Project",
    "type": "IfcProject",
    "parent": null
  },
  {
    "id": "0vR3kTm8v2VPx_j7D9Hxk",
    "name": "Site",
    "type": "IfcSite",
    "parent": "2hk9fGH$H4Pxj3f8v_Dxg7"
  },
  {
    "id": "1Bx7mKj3v4RxPd_8kD9Hx",
    "name": "Building A",
    "type": "IfcBuilding",
    "parent": "0vR3kTm8v2VPx_j7D9Hxk"
  },
  {
    "id": "3toKckUfH2jBmd$7xKikH0",
    "name": "Level 1",
    "longName": "First Floor",
    "type": "IfcBuildingStorey",
    "parent": "1Bx7mKj3v4RxPd_8kD9Hx",
    "attributes": {
      "elevation": 0.0
    }
  },
  {
    "id": "1Ri6dAvFvEOxun_An4x7m_",
    "name": "Basic Wall:Generic - 6\"",
    "type": "IfcWall",
    "parent": "3toKckUfH2jBmd$7xKikH0",
    "ObjectType": "Basic Wall:Generic - 6\"",
    "tag": "291086",
    "propertySetIds": ["3fG7k$Hj2_9Pxd8vD_xg7", "1Wx8mNh3v5RxPd_7kD9xm"]
  },
  {
    "id": "2Cx9dGv7r3Nxdk_Bm5Ykj",
    "name": "M_Single-Flush:36\" x 84\"",
    "type": "IfcDoor",
    "parent": "1Ri6dAvFvEOxun_An4x7m_",
    "ObjectType": "M_Single-Flush:36\" x 84\"",
    "tag": "291234",
    "propertySetIds": ["4gH8l$Ik3_0Qye9wE_yh8"]
  }
]
```

### Common IFC Types

**Spatial Elements:**
- `IfcProject` - Root of the hierarchy
- `IfcSite` - Construction site
- `IfcBuilding` - Building structure
- `IfcBuildingStorey` - Floor/level
- `IfcSpace` - Room or space

**Building Elements:**
- `IfcWall`, `IfcWallStandardCase`
- `IfcSlab`
- `IfcColumn`
- `IfcBeam`
- `IfcDoor`
- `IfcWindow`
- `IfcStair`
- `IfcRoof`
- `IfcCurtainWall`

**MEP Elements:**
- `IfcPipeSegment`
- `IfcDuctSegment`
- `IfcCableSegment`
- `IfcFlowTerminal`

---

## Relationship Between Arrays

### Properties → PropertySets → MetaObjects

```
properties[0] = { "name": "LoadBearing", "value": "True", ... }
properties[1] = { "name": "Height", "value": 3.5, ... }
    ↑
    │ Referenced by index
    │
propertySets[0] = {
  "id": "pset-guid-123",
  "name": "Pset_WallCommon",
  "properties": [0, 1]
}
    ↑
    │ Referenced by GUID
    │
metaObjects[4] = {
  "id": "wall-guid-456",
  "type": "IfcWall",
  "propertySetIds": ["pset-guid-123"]
}
```

### Units → Properties

```
units[0] = { "name": "m", "unitEnum": "LENGTHUNIT", ... }
    ↑
    │ Referenced by index
    │
properties[1] = {
  "name": "Height",
  "value": 3.5,
  "unit": 0
}
```

### ProjectUnits → Units

```
units[0] = { "name": "m", ... }
units[1] = { "name": "mm", ... }
    ↑
    │ Referenced by index
    │
projectUnits = {
  "LENGTHUNIT": 0,
  "AREAUNIT": 2
}
```

---

## Deduplication

Properties should be deduplicated to reduce file size:

### Hash Calculation

```cpp
hash = hash_combine(
  property_name,
  property_value,
  property_type,
  unit_index
);
```

### Deduplication Process

1. Calculate hash for each property
2. Check if hash exists in cache
3. If exists: Reuse existing property index
4. If new: Add to `properties` array with new index

### Example

```json
// Property defined once
"properties": [
  {
    "name": "LoadBearing",
    "value": "True",
    "valueType": "boolean"
  }
]

// Multiple property sets reference same property
"propertySets": [
  { "id": "pset-1", "properties": [0] },
  { "id": "pset-2", "properties": [0] },
  { "id": "pset-3", "properties": [0] }
]
```

---

## Complete Example

```json
{
  "id": "building_project_2024",
  "projectId": "2hk9fGH$H4Pxj3f8v_Dxg7",
  "author": "John Doe",
  "createdAt": "2024-02-19T12:14:41",
  "schema": "IFC4",
  "creatingApplication": "Autodesk Revit 2024",

  "properties": [
    {
      "name": "LoadBearing",
      "ifcPropertyType": "IfcPropertySingleValue",
      "ifcValueType": "IfcBoolean",
      "value": "True",
      "valueType": "boolean"
    },
    {
      "name": "Height",
      "ifcPropertyType": "IfcPropertySingleValue",
      "ifcValueType": "IfcLengthMeasure",
      "value": 3.5,
      "valueType": "number",
      "unit": 0
    },
    {
      "name": "FireRating",
      "ifcPropertyType": "IfcPropertySingleValue",
      "ifcValueType": "IfcLabel",
      "value": "2 Hour",
      "valueType": "string"
    },
    {
      "name": "GrossVolume",
      "ifcPropertyType": "IfcQuantityVolume",
      "value": 12.5,
      "valueType": "ElementQuantity",
      "unit": 3
    }
  ],

  "propertySets": [
    {
      "id": "3fG7k$Hj2_9Pxd8vD_xg7",
      "name": "Pset_WallCommon",
      "type": "IfcPropertySet",
      "properties": [0, 1, 2]
    },
    {
      "id": "1Wx8mNh3v5RxPd_7kD9xm",
      "name": "BaseQuantities",
      "type": "IfcElementQuantity",
      "properties": [3]
    }
  ],

  "units": [
    {
      "name": "m",
      "className": "IfcSIUnit",
      "unitEnum": "LENGTHUNIT"
    },
    {
      "name": "mm",
      "className": "IfcSIUnit",
      "unitEnum": "LENGTHUNIT",
      "prefix": "MILLI"
    },
    {
      "name": "m2",
      "className": "IfcSIUnit",
      "unitEnum": "AREAUNIT"
    },
    {
      "name": "m3",
      "className": "IfcSIUnit",
      "unitEnum": "VOLUMEUNIT"
    },
    {
      "name": "degree",
      "className": "IfcConversionBasedUnit",
      "unitEnum": "PLANEANGLEUNIT",
      "conversionFactor": {
        "valueComponent": {
          "value": 0.0174532925199433,
          "valueType": "number",
          "ifcValueType": "IfcReal"
        },
        "unitComponent": 5
      }
    },
    {
      "name": "rad",
      "className": "IfcSIUnit",
      "unitEnum": "PLANEANGLEUNIT"
    }
  ],

  "projectUnits": {
    "LENGTHUNIT": 0,
    "AREAUNIT": 2,
    "VOLUMEUNIT": 3,
    "PLANEANGLEUNIT": 4
  },

  "metaObjects": [
    {
      "id": "2hk9fGH$H4Pxj3f8v_Dxg7",
      "name": "My Building Project",
      "type": "IfcProject",
      "parent": null
    },
    {
      "id": "0vR3kTm8v2VPx_j7D9Hxk",
      "name": "Site",
      "type": "IfcSite",
      "parent": "2hk9fGH$H4Pxj3f8v_Dxg7"
    },
    {
      "id": "1Bx7mKj3v4RxPd_8kD9Hx",
      "name": "Building A",
      "type": "IfcBuilding",
      "parent": "0vR3kTm8v2VPx_j7D9Hxk"
    },
    {
      "id": "3toKckUfH2jBmd$7xKikH0",
      "name": "Level 1",
      "longName": "First Floor",
      "type": "IfcBuildingStorey",
      "parent": "1Bx7mKj3v4RxPd_8kD9Hx",
      "attributes": {
        "elevation": 0.0
      }
    },
    {
      "id": "1Ri6dAvFvEOxun_An4x7m_",
      "name": "Basic Wall:Generic - 6\"",
      "type": "IfcWall",
      "parent": "3toKckUfH2jBmd$7xKikH0",
      "ObjectType": "Basic Wall:Generic - 6\"",
      "tag": "291086",
      "propertySetIds": ["3fG7k$Hj2_9Pxd8vD_xg7", "1Wx8mNh3v5RxPd_7kD9xm"]
    },
    {
      "id": "2Cx9dGv7r3Nxdk_Bm5Ykj",
      "name": "M_Single-Flush:36\" x 84\"",
      "type": "IfcDoor",
      "parent": "1Ri6dAvFvEOxun_An4x7m_",
      "ObjectType": "M_Single-Flush:36\" x 84\"",
      "tag": "291234",
      "propertySetIds": ["4gH8l$Ik3_0Qye9wE_yh8"]
    }
  ]
}
```

---

## Usage with glTF/glb Files

### File Pairing

For each glTF/glb geometry file, there's a corresponding metadata.json:

```
output.glb          ← 3D geometry
metadata.json       ← Building metadata
```

### Linking Geometry and Metadata

The link is established through IFC GUIDs:

**In glTF:** (stored in node extras)
```json
{
  "nodes": [
    {
      "name": "1Ri6dAvFvEOxun_An4x7m_",
      "mesh": 5,
    }
  ]
}
```

**In metadata.json:**
```json
{
  "metaObjects": [
    {
      "id": "1Ri6dAvFvEOxun_An4x7m_",
      "name": "Basic Wall:Generic - 6\"",
      "type": "IfcWall",
      "propertySetIds": [...]
    }
  ]
}
```

**Matching:** `node.name === metaObject.id`

---

## Summary

The metadata.json file provides a complete semantic representation of the IFC building model:

- **Hierarchical structure** through `metaObjects` with parent-child relationships
- **Rich properties** through `properties`, `propertySets`, and references
- **Unit definitions** with conversions and project-level defaults
- **Optimized storage** through deduplication and optional file splitting
- **Flexible linking** to glTF geometry via IFC GUIDs

This separation enables efficient workflows for both visualization (geometry only) and data analysis (metadata only or combined).
